# QA Report — CoS Full Sweep — 2026-02-24

## Scope
All 3 repos: CoS parent (command system), donna-server (API/backend), whatsapp-mcp (Go bridge).

## Results Summary

| Repo | Typecheck | Tests | Smoke Test | Findings | Fixed |
|------|-----------|-------|------------|----------|-------|
| donna-server | PASS | 68/68 | 4/4 | 19 | 3 |
| whatsapp-mcp | PASS (vet) | 27/27 | N/A | 19 | 0 |
| CoS commands | N/A | N/A | N/A | 16 | 8 |
| **Total** | | | | **54** | **11** |

## Fixes Applied This Session

| # | Repo | What | File(s) |
|---|------|------|---------|
| 1 | donna-server | Deduplicated `chunkText` — telegram.ts now imports from telegram-send.ts | `src/telegram.ts` |
| 2 | CoS | Fixed stale `scheduler.ts` ref in donna-scheduled-tasks.md | `docs/donna-scheduled-tasks.md` |
| 3 | CoS | Fixed stale `scheduler.ts` ref in source-of-record.md | `assets/source-of-record.md` |
| 4 | CoS | Unchecked 4 false completion markers (retro, mirror, review-queue, debrief crons not in cron.ts) | `assets/setup-backlog.md` |
| 5 | CoS | Standardized `/health` command structure (added title, description, usage, instructions sections) | `.claude/commands/health.md` |
| 6 | CoS | Rewrote validate-consistency.sh for cron.ts (was scheduler.ts), added name normalization | `tests/validate-consistency.sh` |
| 7 | CoS | Smoke test script added to donna-server | `donna-server/scripts/smoke-test.sh` |
| 8 | CoS | Fixed bash arithmetic bug in smoke test (PASS++ exit code) | `donna-server/scripts/smoke-test.sh` |

---

## Open Findings — donna-server

### Critical (needs investigation, not code-fixable in isolation)

| # | Severity | Location | Description | Action |
|---|----------|----------|-------------|--------|
| 1 | HIGH | `agent.ts:97-100` | Timer leak on query timeout — queryPromise keeps running after timeout fires, no abort signal | Track: add AbortController support when Agent SDK supports it |
| 2 | HIGH | `agent.ts:24-31` | Race condition in session persistence — two different chatIds can corrupt sessions.json (read-modify-write without lock) | Fix: add a global write lock or use atomic file writes |
| 3 | HIGH | `telegram.ts:123-155` | Reaction handler calls chat() without message_id context — agent halluccinates which message was reacted to | Fix: include original message text in prompt |

### Medium

| # | Location | Description |
|---|----------|-------------|
| 4 | `git-sync.ts:41-44` | git add -A after rebase may stage unintended files |
| 5 | `index.ts:33-45` | No request body size limit on webhook endpoint |
| 6 | `telegram-send.ts:37-44` | Bot token in URL could leak if error includes URL |
| 7 | `cron.ts:39-46` | `toLocaleString` time parsing depends on ICU data in Docker |

### Low/Info

| # | Location | Description |
|---|----------|-------------|
| 8 | `agent.ts:55` | Model string hardcoded (claude-sonnet-4-5-20250929) |
| 9 | `index.ts:67` | Git sync interval not guarded against concurrent runs |
| 10 | `cron.ts:301` | Direct execution detection is brittle |
| 11 | `package.json` | Agent SDK 0.1.77 vs latest 0.2.51 — major version gap |
| 12 | `tests/config.test.ts` | Legacy test file overlaps with src/__tests__/config.test.ts |

### Untested Code Paths
- `index.ts` — entire HTTP server, webhook handler, graceful shutdown
- `telegram.ts` — bot handlers (text, voice, reaction), sendReply with voice
- `cron.ts` — runJob(), handleHealthCheckResult(), main()
- `agent.ts` — query timeout path, error propagation in serialization lock

---

## Open Findings — whatsapp-mcp

| # | Severity | Location | Description |
|---|----------|----------|-------------|
| 1 | HIGH | `main.go:711-819` | No authentication on REST API (localhost-only, but any local process can send WhatsApp messages) |
| 2 | HIGH | `main.go:713` | Uses http.DefaultServeMux (global), no graceful shutdown |
| 3 | HIGH | `main.go:814-818` | HTTP server error not propagated, server has no shutdown |
| 4 | MEDIUM | `main.go:958` | GetChatName bypasses MessageStore abstraction |
| 5 | MEDIUM | `main.go:977-1003` | reflect used for struct field extraction (fragile) |
| 6 | MEDIUM | `main.go:1240` | Dead code: `if true {` block |
| 7 | MEDIUM | `main.go:894` | QR channel error discarded |
| 8 | LOW | `main.go:940` | Port 8080 hardcoded |
| 9 | LOW | `main.go:1-1345` | Entire app in single 1345-line file |
| 10 | LOW | `.gitignore` | Compiled binary not excluded |

---

## Open Findings — CoS Command System

### Critical (needs live Notion verification)

| # | Location | Description |
|---|----------|-------------|
| 1 | Multiple commands | Priority field: commands use 4-value scale (Urgent/High/Medium/Low) but Notion schema docs show 3 (Low/Medium/High). Either Notion was updated or commands will fail setting "Urgent". |
| 2 | `review-queue.md:19` | Status field: uses "Needs Review", "Blocked", "Waiting on Vahid" which aren't in canonical schema. Needs live DB check. |

### Medium

| # | Location | Description |
|---|----------|-------------|
| 3 | `deal-prep.md` | No Prospecting DB ID documented |
| 4 | `deal-prep.md:131` | Priority format inconsistent (string vs numeric mapping) |
| 5 | `gm.md:19`, `meeting-prep.md:17` | Ambiguous MCP tool references (say "list-events" without full tool name) |
| 6 | `gm.md` Step 2 | Auto-fix tasks contradicts safety rule about autonomous task completion |

### Low

| # | Location | Description |
|---|----------|-------------|
| 7 | `goals.yaml:42,55` | "Instant.ly" should be "Instantly" |
| 8 | `deal-prep.md:122,132` | Implicit status mapping (in_progress ↔ WIP) undocumented |
| 9 | `enrich.md:17` | References non-existent contact-index.yaml (marked optional) |

---

## Validation Results

```
validate-consistency.sh: 18 passed, 0 failed, 2 warnings
donna-server tests:      68 passed, 0 failed
donna-server typecheck:  0 errors
donna-server smoke test: 4 passed, 0 failed
whatsapp-mcp tests:      27 passed, 0 failed
whatsapp-mcp vet:        0 issues
whatsapp-mcp race:       0 data races
```

Warnings (2): overdue tasks in my-tasks.yaml — not a QA concern.
